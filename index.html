<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FEH Damage Calculator</title>
    <style>
        :root {
            --primary: #0078d4;
            --hover: #006cbf;
            --border: #e1e4e8;
            --bg-light: #fafafa;
            --text: #1a1a1a;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; }
        body { background: #f0f2f5; min-height: 100vh; display: flex; flex-direction: column; color: var(--text); }
        .navbar { background: linear-gradient(90deg, var(--primary), #00bcf2); color: #fff; padding: 1rem; position: fixed; top: 0; width: 100%; z-index: 10; text-align: center; }
        .navbar h1 { font-size: clamp(1.25rem, 2.5vw, 1.5rem); font-weight: 400; }
        .container { flex: 1; display: flex; padding-top: 4rem; }
        .calculator { display: flex; flex: 1; border: 1px solid var(--border); }
        .input-section { flex: 1; padding: 1.5rem; background: var(--bg-light); border-right: 1px solid var(--border); overflow-y: auto; }
        details { margin-bottom: 1rem; }
        summary { font-size: 1.1rem; font-weight: 500; cursor: pointer; padding: .5rem; }
        .section { margin-bottom: 1rem; }
        label { display: block; font-size: clamp(.875rem, 2vw, 1rem); font-weight: 500; }
        input[type="number"], select { width: 100%; padding: .75rem; font-size: clamp(.875rem, 2vw, 1rem); border: 1px solid #d1d3d4; border-radius: 4px; outline: none; transition: border-color .2s; }
        input[type="number"]:focus, select:focus { border-color: var(--primary); }
        input[type="checkbox"] { margin-right: .5rem; }
        .button-group { display: flex; gap: 1rem; }
        button { flex: 1; padding: .875rem; font-size: clamp(.875rem, 2vw, 1rem); border: none; border-radius: 4px; background: var(--primary); color: #fff; cursor: pointer; transition: background .2s; }
        button:hover { background: var(--hover); }
        .result-section { flex: 1; padding: 1.5rem; display: flex; flex-direction: column; overflow-y: auto; }
        #result { font-size: clamp(1.5rem, 3vw, 2rem); color: var(--primary); text-align: center; padding: 1rem 0; font-weight: 600; border-bottom: 1px solid var(--border); }
        #log { flex: 1; padding-top: 1rem; font-size: clamp(.875rem, 2vw, 1rem); line-height: 1.5; }
        #log p { margin-bottom: .5rem; padding-left: 1rem; }
        #log details { margin: .5rem 0; }
        #log summary { padding: .25rem; }
        #specialDesc { font-size: .9rem; color: #555; margin-top: .5rem; }
        @media (max-width: 768px) {
            .calculator { flex-direction: column; }
            .input-section { border-right: none; border-bottom: 1px solid var(--border); }
        }
        @media (max-width: 480px) {
            .container { padding-top: 3.5rem; }
            .input-section, .result-section { padding: 1rem; }
            .button-group { flex-direction: column; gap: .5rem; }
        }
    </style>
</head>
<body>
    <div class="navbar"><h1>FEH Damage Calculator</h1></div>
    <div class="container">
        <div class="calculator">
            <div class="input-section">
                <details open>
                    <summary>Unit Stats</summary>
                    <div class="section"><label>Attacker's Atk</label><input type="number" id="atk" min="0" max="99"></div>
                    <div class="section"><label>Atk Buff (±)</label><input type="number" id="atkBuff" min="-99" max="99" value="0"></div>
                    <div class="section"><label>Attacker's Spd</label><input type="number" id="atkSpd" min="0" max="99"></div>
                    <div class="section"><label>Attacker's HP</label><input type="number" id="atkHP" min="0" max="99"></div>
                    <div class="section"><label>Max HP</label><input type="number" id="atkMaxHP" min="0" max="99"></div>
                    <div class="section"><label>Defender's Def</label><input type="number" id="def" min="0" max="99"></div>
                    <div class="section"><label>Defender's Res</label><input type="number" id="res" min="0" max="99"></div>
                    <div class="section"><label>Def/Res Buff (±)</label><input type="number" id="defBuff" min="-99" max="99" value="0"></div>
                    <div class="section"><label>Defender's Spd</label><input type="number" id="defSpd" min="0" max="99"></div>
                    <div class="section"><label>Defender's HP</label><input type="number" id="defHP" min="0" max="99"></div>
                    <div class="section"><label>Max HP</label><input type="number" id="defMaxHP" min="0" max="99"></div>
                </details>
                <details open>
                    <summary>Combat Modifiers</summary>
                    <div class="section">
                        <label>Damage Type</label>
                        <select id="damageType">
                            <option value="physical">Physical (Def)</option>
                            <option value="magical">Magical (Res)</option>
                            <option value="adaptive">Adaptive (Lower)</option>
                        </select>
                    </div>
                    <div class="section">
                        <label>Weapon Type</label>
                        <select id="weaponType">
                            <option value="normal">Normal</option>
                            <option value="staff">Staff (x0.5)</option>
                        </select>
                    </div>
                    <div class="section">
                        <label>Triangle</label>
                        <select id="triangle">
                            <option value="neutral">Neutral</option>
                            <option value="advantage">Advantage (+20%)</option>
                            <option value="disadvantage">Disadvantage (-20%)</option>
                        </select>
                    </div>
                    <div class="section">
                        <label>Effective</label>
                        <select id="effective">
                            <option value="no">No (x1)</option>
                            <option value="yes">Yes (x1.5)</option>
                        </select>
                    </div>
                    <div class="section">
                        <label>Special</label>
                        <select id="special">
                            <option value="none">None</option>
                            <option value="moonbow">Moonbow</option>
                            <option value="glimmer">Glimmer</option>
                            <option value="astra">Astra</option>
                            <option value="aether">Aether</option>
                            <option value="dragonFang">Dragon Fang</option>
                            <option value="deadeye">Deadeye</option>
                            <option value="pavise">Pavise</option>
                            <option value="iceMirror">Ice Mirror</option>
                            <option value="escutcheon">Escutcheon</option>
                            <option value="blazingWind">Blazing Wind</option>
                            <option value="risingThunder">Rising Thunder</option>
                            <option value="growingLight">Growing Light</option>
                        </select>
                        <p id="specialDesc">None</p>
                    </div>
                    <div class="section"><label>Special Charge</label><input type="number" id="specialCharge" min="0" max="5" value="0"></div>
                    <div class="section"><label>True Damage</label><input type="number" id="trueDamage" min="0" max="99" value="0"></div>
                    <div class="section">
                        <label>Pre-Combat Damage</label>
                        <input type="number" id="preCombatDamage" min="0" max="99" value="0">
                        <label><input type="checkbox" id="unmitigated"> Unmitigated</label>
                    </div>
                    <div class="section"><label>Pierce DR (%)</label><input type="number" id="pierceDR" min="0" max="100" value="0"></div>
                    <div class="section">
                        <label>Critical</label>
                        <select id="critical">
                            <option value="1">None (x1)</option>
                            <option value="2">x2</option>
                            <option value="3">x3</option>
                        </select>
                    </div>
                    <div class="section">
                        <label>Terrain</label>
                        <select id="terrain">
                            <option value="none">None</option>
                            <option value="defensive">Defensive (+30%)</option>
                        </select>
                    </div>
                    <div class="section"><label>Reduction (%)</label><input type="number" id="percentReduction" min="0" max="100" value="0"></div>
                </details>
                <div class="button-group">
                    <button onclick="calculateDamage()">Calculate</button>
                    <button onclick="resetForm()">Reset</button>
                </div>
            </div>
            <div class="result-section">
                <div id="result">Damage: -</div>
                <div id="log"><p>Calculation steps will appear here.</p></div>
            </div>
        </div>
    </div>
    <script>
        const clamp = (v, min, max) => Math.min(Math.max(v, min), max);
        const get = (id, type = 'value') => document.getElementById(id)[type];
        const getInput = (id, min, max, d = 0) => clamp(parseInt(get(id)) || d, min, max);
        const getSelect = id => get(id);
        const getCheckbox = id => get(id, 'checked');

        const modifyStats = {
            triangle: (atk, type, log, formula) => {
                const m = { advantage: 1.2, disadvantage: 0.8, neutral: 1 };
                const r = Math.floor(atk * (m[type] || 1));
                if (type !== 'neutral') log.push(`Triangle ${type} (${m[type] === 1.2 ? '+20%' : '-20%'}: ${r})`);
                return r;
            },
            effective: (atk, eff, log, formula) => {
                if (eff === 'yes') {
                    atk = Math.floor(atk * 1.5);
                    log.push(`Effective: x1.5 to ${atk}`);
                    formula.push('Effective(x1.5)');
                }
                return atk;
            },
            terrain: (def, type, log, formula) => {
                if (type === 'defensive') {
                    def = Math.floor(def * 1.3);
                    log.push(`Terrain: Def/Res +30% to ${def}`);
                    formula.push('Terrain(+30%)');
                }
                return def;
            },
            special: ({ baseDamage, def, type, damageType, attacker, defender, charge }, log, formula) => {
                const specials = {
                    moonbow: { fn: () => Math.floor(def * 0.3), desc: `+30% ${damageType === 'physical' ? 'Def' : 'Res'}`, cd: 2 },
                    glimmer: { fn: () => Math.floor(baseDamage * 0.5), desc: '+50% Damage', cd: 2 },
                    astra: { fn: () => Math.floor(baseDamage * 1.5), desc: 'x2.5 Damage', cd: 5 },
                    aether: { fn: () => {
                        const d = Math.floor(def * 0.5);
                        state.postCombatEffects.push({ target: 'attacker', stat: 'hp', value: Math.floor(d * 0.5) });
                        return d;
                    }, desc: '+50% Def/Res, heal 50%', cd: 5 },
                    dragonFang: { fn: () => Math.floor(attacker.atk * 0.5), desc: '+50% Atk', cd: 4 },
                    deadeye: { fn: () => baseDamage * 2, desc: 'x2 Damage, neutralizes DR', cd: 3, pierceDR: true },
                    pavise: { fn: () => (state.damageReduction += 0.5, 0), desc: '-50% Physical Damage', cd: 3 },
                    iceMirror: { fn: () => {
                        state.damageReduction += 0.3;
                        const r = Math.floor(baseDamage * 0.3);
                        state.totalDamage += r;
                        return r;
                    }, desc: '-30% Magic Damage, reflect 30%', cd: 2 },
                    escutcheon: { fn: () => (state.damageReduction += 0.3, 0), desc: '-30% All Damage', cd: 2 },
                    blazingWind: { fn: () => Math.floor(attacker.atk - defender.res), desc: 'Atk - Res AoE', cd: 4, aoe: true },
                    risingThunder: { fn: () => Math.floor(attacker.atk - defender.def), desc: 'Atk - Def AoE', cd: 4, aoe: true },
                    growingLight: { fn: () => {
                        const d = Math.floor(attacker.atk * 0.5);
                        state.postCombatEffects.push({ target: 'attacker', stat: 'atk', value: 6 });
                        return d;
                    }, desc: '50% Atk AoE, +6 Atk', cd: 4, aoe: true }
                };
                const spec = specials[type] || { fn: () => 0, desc: 'None', cd: 0 };
                if (charge > spec.cd) return 0;
                const d = spec.fn();
                if (d || spec.pierceDR || spec.damageReduction || spec.aoe) {
                    log.push(`${type.charAt(0).toUpperCase() + type.slice(1)}: ${d ? `Adds ${d}` : 'Applies'} (${spec.desc})`);
                    formula.push(`<span style="color:${spec.aoe ? '#ff4500' : spec.damageReduction ? '#4682b4' : '#dc143c'}">${type.charAt(0).toUpperCase() + type.slice(1)}(${d || 'Effect'})</span>`);
                    if (spec.pierceDR) state.pierceDR = 1;
                    if (spec.aoe) state.aoeEffects.push({ damage: d, range: 2 });
                }
                return d;
            }
        };

        let state;
        function calculateDamage() {
            const log = [], formula = [];
            state = {
                totalDamage: 0,
                damageReduction: 0,
                postCombatEffects: [],
                aoeEffects: [],
                pierceDR: 0,
                attacker: {
                    atk: getInput('atk', 0, 99) + getInput('atkBuff', -99, 99),
                    spd: getInput('atkSpd', 0, 99),
                    hp: getInput('atkHP', 0, 99),
                    maxHP: getInput('atkMaxHP', 0, 99, getInput('atkHP', 0, 99))
                },
                defender: {
                    def: getInput('def', 0, 99) + getInput('defBuff', -99, 99),
                    res: getInput('res', 0, 99) + getInput('defBuff', -99, 99),
                    spd: getInput('defSpd', 0, 99),
                    hp: getInput('defHP', 0, 99),
                    maxHP: getInput('defMaxHP', 0, 99, getInput('defHP', 0, 99))
                },
                combat: {
                    damageType: getSelect('damageType'),
                    weaponType: getSelect('weaponType'),
                    triangle: getSelect('triangle'),
                    effective: getSelect('effective'),
                    special: getSelect('special'),
                    charge: getInput('specialCharge', 0, 5),
                    trueDamage: getInput('trueDamage', 0, 99),
                    preCombatDamage: getInput('preCombatDamage', 0, 99),
                    unmitigated: getCheckbox('unmitigated'),
                    pierceDR: getInput('pierceDR', 0, 100) / 100,
                    critical: parseFloat(getSelect('critical')),
                    terrain: getSelect('terrain'),
                    percentReduction: getInput('percentReduction', 0, 100) / 100
                }
            };

            if (!state.attacker.atk || (!state.defender.def && !state.defender.res)) {
                log.push("Enter Atk and Def or Res.");
                return updateUI(log);
            }

            log.push(`Attacker: Atk=${state.attacker.atk}, Spd=${state.attacker.spd}, HP=${state.attacker.hp}/${state.attacker.maxHP}`);
            log.push(`Defender: Def=${state.defender.def}, Res=${state.defender.res}, Spd=${state.defender.spd}, HP=${state.defender.hp}/${state.defender.maxHP}`);

            const defStat = state.combat.damageType === 'physical' ? state.defender.def : state.combat.damageType === 'magical' ? state.defender.res : Math.min(state.defender.def, state.defender.res);
            log.push(`Effective Def: ${defStat} (${state.combat.damageType})`);

            state.totalDamage = state.combat.unmitigated ? state.combat.preCombatDamage : Math.max(0, state.combat.preCombatDamage - defStat);
            if (state.combat.preCombatDamage) {
                log.push(`Pre-Combat: ${state.totalDamage}${state.combat.unmitigated ? ' (Unmitigated)' : ''}`);
                formula.push(`PreCombat(${state.totalDamage})`);
            }

            let atk = modifyStats.triangle(state.attacker.atk, state.combat.triangle, log, formula);
            atk = modifyStats.effective(atk, state.combat.effective, log, formula);
            let def = modifyStats.terrain(defStat, state.combat.terrain, log, formula);

            state.baseDamage = Math.max(0, atk - def);
            state.totalDamage += state.baseDamage;
            log.push(`Base Damage: ${state.baseDamage} (Atk ${atk} - Def ${def})`);
            formula.push(`Base(${state.baseDamage})`);

            state.def = def;
            state.damageType = state.combat.damageType;
            state.totalDamage += modifyStats.special(state, log, formula);

            if (state.combat.trueDamage) {
                state.totalDamage += state.combat.trueDamage;
                log.push(`True Damage: +${state.combat.trueDamage}`);
                formula.push(`True(${state.combat.trueDamage})`);
            }

            state.aoeEffects.forEach(e => log.push(`AoE: Deals ${e.damage} within ${e.range} spaces`));
            state.postCombatEffects.forEach(e => log.push(`Post-Combat: ${e.target === 'attacker' ? 'Attacker' : 'Defender'} ${e.stat.toUpperCase()} ${e.value > 0 ? '+' : ''}${e.value}`));

            const preReduction = state.totalDamage;
            state.damageReduction += state.combat.percentReduction;
            const effReduction = state.damageReduction * (1 - Math.max(state.pierceDR, state.combat.pierceDR));
            state.totalDamage = Math.floor(state.totalDamage * (1 - effReduction));
            if (effReduction > 0) {
                log.push(`Reduction: ${Math.round(effReduction * 100)}% (${preReduction} → ${state.totalDamage})`);
                formula.push(`Reduction(-${Math.round(effReduction * 100)}%)`);
            }

            state.totalDamage = Math.floor(state.totalDamage * state.combat.critical * (state.combat.weaponType === 'staff' ? 0.5 : 1));

            const atkHP = state.attacker.hp + (state.postCombatEffects.find(e => e.target === 'attacker' && e.stat === 'hp')?.value || 0);
            const defHP = state.defender.hp - state.totalDamage;
            log.push(`HP Left: Attacker=${atkHP}/${state.attacker.maxHP}, Defender=${defHP}/${state.defender.maxHP}`);

            const formulaStr = formula.length ? `${formula.join(' + ')} = ${state.totalDamage}` : "No damage.";
            log.push(`<details><summary>Formula View</summary><p>${formulaStr}</p></details>`);

            updateUI(log, state.totalDamage);
        }

        function updateUI(log, damage = '-') {
            get('result', 'innerText') = `Damage: ${damage}`;
            get('log', 'innerHTML') = log.map(s => s.startsWith('<details') ? s : `<p>${s}</p>`).join('');
            get('specialDesc', 'innerText') = modifyStats.special.descriptions[getSelect('special')] || 'None';
        }

        function resetForm() {
            document.querySelectorAll('input[type="number"]').forEach(i => i.value = '');
            document.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
            document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
            updateUI(["Calculation steps will appear here."]);
        }

        modifyStats.special.descriptions = {
            none: 'None',
            moonbow: 'Adds 30% Def/Res (CD: 2)',
            glimmer: 'Adds 50% Damage (CD: 2)',
            astra: 'x2.5 Damage (CD: 5)',
            aether: 'Adds 50% Def/Res, heals 50% (CD: 5)',
            dragonFang: 'Adds 50% Atk (CD: 4)',
            deadeye: 'x2 Damage, neutralizes DR (CD: 3)',
            pavise: 'Reduces physical by 50% (CD: 3)',
            iceMirror: 'Reduces magic by 30%, reflects 30% (CD: 2)',
            escutcheon: 'Reduces all by 30% (CD: 2)',
            blazingWind: 'Atk - Res AoE (CD: 4)',
            risingThunder: 'Atk - Def AoE (CD: 4)',
            growingLight: '50% Atk AoE, +6 Atk (CD: 4)'
        };

        document.getElementById('special').addEventListener('change', () => {
            get('specialDesc', 'innerText') = modifyStats.special.descriptions[getSelect('special')] || 'None';
        });
    </script>
</body>
</html>
