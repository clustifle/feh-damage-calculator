<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FEH Damage Calculator</title>
    <style>
        :root {
            --primary: #0078d4;
            --hover: #006cbf;
            --border: #e1e4e8;
            --bg-light: #fafafa;
            --text: #1a1a1a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        body {
            background: #f0f2f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text);
        }

        .navbar {
            background: linear-gradient(90deg, var(--primary), #00bcf2);
            color: #fff;
            padding: 1rem;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 10;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .navbar h1 {
            font-size: clamp(1.25rem, 2.5vw, 1.5rem);
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        .container {
            flex: 1;
            display: flex;
            width: 100%;
            padding-top: 4rem;
            background: #ffffff;
        }

        .calculator {
            display: flex;
            flex: 1;
            background: #ffffff;
            border: 1px solid var(--border);
        }

        .input-section {
            flex: 1;
            padding: 1.5rem;
            background: var(--bg-light);
            border-right: 1px solid var(--border);
            overflow-y: auto;
        }

        details {
            margin-bottom: 1rem;
        }

        summary {
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            padding: 0.5rem;
        }

        .section {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-size: clamp(0.875rem, 2vw, 1rem);
            color: var(--text);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input[type="number"], select, input[type="checkbox"] {
            width: 100%;
            padding: 0.75rem;
            font-size: clamp(0.875rem, 2.5vw, 1rem);
            border: 1px solid #d1d3d4;
            border-radius: 4px;
            background: #fff;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
        }

        input[type="number"]:focus, select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 5px rgba(0, 120, 212, 0.3);
        }

        .button-group {
            display: flex;
            gap: 1rem;
        }

        button {
            flex: 1;
            padding: 0.875rem;
            font-size: clamp(0.875rem, 2.5vw, 1rem);
            border: none;
            border-radius: 4px;
            background: var(--primary);
            color: #fff;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: var(--hover);
        }

        .result-section {
            flex: 1;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            overflow-y: auto;
        }

        #result {
            font-size: clamp(1.5rem, 3.5vw, 2rem);
            color: var(--primary);
            text-align: center;
            padding: 1rem 0;
            font-weight: 600;
            border-bottom: 1px solid var(--border);
        }

        #log {
            flex: 1;
            padding-top: 1rem;
            font-size: clamp(0.875rem, 2vw, 1rem);
            color: var(--text);
            line-height: 1.5;
            overflow-y: auto;
        }

        #log p {
            margin-bottom: 0.5rem;
        }

        @media (max-width: 768px) {
            .calculator {
                flex-direction: column;
            }

            .input-section {
                border-right: none;
                border-bottom: 1px solid var(--border);
            }

            .result-section {
                min-height: 300px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding-top: 3.5rem;
            }

            .calculator {
                border: none;
            }

            .input-section, .result-section {
                padding: 1rem;
            }

            .section {
                margin-bottom: 0.75rem;
            }

            .button-group {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>FEH Damage Calculator</h1>
    </div>
    <div class="container">
        <div class="calculator">
            <!-- Left Side: Inputs -->
            <div class="input-section">
                <details open>
                    <summary>Unit Stats</summary>
                    <div class="section">
                        <label>Attacker's Atk</label>
                        <input type="number" id="atk" min="0" max="99" placeholder="....">
                    </div>
                    <div class="section">
                        <label>Atk Buff/Debuff (±)</label>
                        <input type="number" id="atkBuff" min="-99" max="99" placeholder="0">
                    </div>
                    <div class="section">
                        <label>Attacker's Spd</label>
                        <input type="number" id="atkSpd" min="0" max="99" placeholder="....">
                    </div>
                    <div class="section">
                        <label>Attacker's HP</label>
                        <input type="number" id="atkHP" min="0" max="99" placeholder="....">
                    </div>
                    <div class="section">
                        <label>Attacker's Max HP</label>
                        <input type="number" id="atkMaxHP" min="0" max="99" placeholder="....">
                    </div>
                    <div class="section">
                        <label>Defender's Def</label>
                        <input type="number" id="def" min="0" max="99" placeholder="....">
                    </div>
                    <div class="section">
                        <label>Defender's Res</label>
                        <input type="number" id="res" min="0" max="99" placeholder="....">
                    </div>
                    <div class="section">
                        <label>Def/Res Buff/Debuff (±)</label>
                        <input type="number" id="defBuff" min="-99" max="99" placeholder="0">
                    </div>
                    <div class="section">
                        <label>Defender's Spd</label>
                        <input type="number" id="defSpd" min="0" max="99" placeholder="....">
                    </div>
                    <div class="section">
                        <label>Defender's HP</label>
                        <input type="number" id="defHP" min="0" max="99" placeholder="....">
                    </div>
                    <div class="section">
                        <label>Defender's Max HP</label>
                        <input type="number" id="defMaxHP" min="0" max="99" placeholder="....">
                    </div>
                </details>
                <details open>
                    <summary>Combat Modifiers</summary>
                    <div class="section">
                        <label>Damage Type</label>
                        <select id="damageType">
                            <option value="physical">Physical (Def)</option>
                            <option value="magical">Magical (Res)</option>
                            <option value="adaptive">Adaptive (Lower of Def/Res)</option>
                        </select>
                    </div>
                    <div class="section">
                        <label>Weapon Type</label>
                        <select id="weaponType">
                            <option value="normal">Normal</option>
                            <option value="staff">Staff (x0.5 Damage)</option>
                        </select>
                    </div>
                    <div class="section">
                        <label>Weapon Triangle</label>
                        <select id="triangle">
                            <option value="neutral">Neutral (0%)</option>
                            <option value="advantage">Advantage (+20%)</option>
                            <option value="disadvantage">Disadvantage (-20%)</option>
                        </select>
                    </div>
                    <div class="section">
                        <label>Effective Damage</label>
                        <select id="effective">
                            <option value="no">No (x1)</option>
                            <option value="yes">Yes (x1.5)</option>
                        </select>
                    </div>
                    <div class="section">
                        <label>Special</label>
                        <select id="special">
                            <option value="none">None</option>
                            <option value="moonbow">Moonbow (+30% Def/Res)</option>
                            <option value="glimmer">Glimmer (+50% Damage)</option>
                            <option value="astra">Astra (x2.5 Damage)</option>
                        </select>
                    </div>
                    <div class="section">
                        <label>True Damage</label>
                        <input type="number" id="trueDamage" min="0" max="99" placeholder="0">
                    </div>
                    <div class="section">
                        <label>Pre-Combat Damage</label>
                        <input type="number" id="preCombatDamage" min="0" max="99" placeholder="0">
                        <label><input type="checkbox" id="unmitigated"> Unmitigated</label>
                    </div>
                    <div class="section">
                        <label>Emblem Effect</label>
                        <select id="emblemEffect">
                            <option value="none">None</option>
                            <option value="ike">Emblem Ike (Null C-Disrupt, 40% DR)</option>
                            <option value="lyn">Emblem Lyn (+7 True Damage)</option>
                        </select>
                    </div>
                    <div class="section">
                        <label>Canto Distance</label>
                        <input type="number" id="cantoDistance" min="0" max="4" placeholder="0">
                        <label><input type="checkbox" id="cantoActive"> Canto Active</label>
                    </div>
                    <div class="section">
                        <label>Pierces Damage Reduction (%)</label>
                        <input type="number" id="pierceDR" min="0" max="100" placeholder="0">
                    </div>
                    <div class="section">
                        <label>Critical Multiplier</label>
                        <select id="critical">
                            <option value="1">None (x1)</option>
                            <option value="2">x2</option>
                            <option value="3">x3</option>
                        </select>
                    </div>
                    <div class="section">
                        <label>Terrain</label>
                        <select id="terrain">
                            <option value="none">None</option>
                            <option value="defensive">Defensive (+30%)</option>
                        </select>
                    </div>
                    <div class="section">
                        <label>Percent Reduction (%)</label>
                        <input type="number" id="percentReduction" min="0" max="100" placeholder="0">
                    </div>
                    <div class="section">
                        <label>Fixed Reduction</label>
                        <input type="number" id="fixedReduction" min="0" max="99" placeholder="0">
                    </div>
                </details>
                <details>
                    <summary>Advanced Stats</summary>
                    <div class="section">
                        <label>Stat Comparison Boost (Damage per 5 excess)</label>
                        <select id="statCompare">
                            <option value="none">None</option>
                            <option value="atkVsDef">Atk vs Def/Res</option>
                            <option value="spdVsSpd">Spd vs Spd</option>
                        </select>
                    </div>
                    <div class="section">
                        <label>HP Threshold Modifier</label>
                        <select id="hpThreshold">
                            <option value="none">None</option>
                            <option value="high">High HP (+5 Damage if ≥80%)</option>
                            <option value="low">Low HP (+20% DR if <50%)</option>
                        </select>
                    </div>
                    <div class="section">
                        <label>Stat-to-Damage Conversion (%)</label>
                        <input type="number" id="statConvertPercent" min="0" max="100" placeholder="0">
                        <select id="statConvert">
                            <option value="none">None</option>
                            <option value="spd">Spd</option>
                            <option value="def">Def/Res</option>
                        </select>
                    </div>
                    <div class="section">
                        <label>Dynamic Stat Scaling (Damage per 10 total stats)</label>
                        <input type="number" id="statScale" min="0" max="10" placeholder="0">
                    </div>
                </details>
                <details>
                    <summary>Skills</summary>
                    <div class="section">
                        <label><input type="checkbox" id="heavyBlade"> Heavy Blade (Special Charge)</label>
                    </div>
                    <div class="section">
                        <label><input type="checkbox" id="deflectMagic"> Deflect Magic (50% Reduction vs Magic)</label>
                    </div>
                    <div class="section">
                        <label><input type="checkbox" id="savior"> Savior Active</label>
                    </div>
                    <div class="section">
                        <label><input type="checkbox" id="warpBubble"> Warp Bubble</label>
                    </div>
                    <div class="section">
                        <label><input type="checkbox" id="nullFollowUp"> Null Follow-Up</label>
                    </div>
                    <div class="section">
                        <label><input type="checkbox" id="guaranteeFollowUp"> Guarantee Follow-Up</label>
                    </div>
                </details>
                <details>
                    <summary>Options</summary>
                    <div class="section">
                        <label>Extra Actions (Galeforce)</label>
                        <input type="number" id="extraActions" min="0" max="3" placeholder="0">
                        <label><input type="checkbox" id="galeforce"> Galeforce Trigger</label>
                    </div>
                    <div class="section">
                        <label>Divine Vein</label>
                        <select id="divineVein">
                            <option value="none">None</option>
                            <option value="stone">Stone (+20% DR)</option>
                            <option value="flame">Flame (+10 True Damage)</option>
                        </select>
                    </div>
                    <div class="section">
                        <label><input type="checkbox" id="counter"> Defender Can Counter</label>
                    </div>
                    <div class="section">
                        <label><input type="checkbox" id="forecast"> Show Combat Forecast</label>
                    </div>
                </details>
                <div class="button-group">
                    <button onclick="calculateDamage()">Calculate Damage</button>
                    <button onclick="resetForm()">Reset</button>
                </div>
            </div>
            <!-- Right Side: Result + Log -->
            <div class="result-section">
                <div id="result">Damage: -</div>
                <div id="log">
                    <p>Calculation steps will appear here.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Utility Functions
        const clamp = (value, min, max) => Math.min(Math.max(value, min), max);
        const getInput = (id, min, max, defaultValue = 0) => clamp(parseInt(document.getElementById(id).value) || defaultValue, min, max);
        const getSelect = (id) => document.getElementById(id).value;
        const getCheckbox = (id) => document.getElementById(id).checked;

        // Stat Modification Functions
        const modifyStats = {
            triangle: (atk, type, log) => {
                const modifiers = { advantage: 1.2, disadvantage: 0.8, neutral: 1 };
                const result = Math.floor(atk * (modifiers[type] || 1));
                if (type !== 'neutral') log.push(`Triangle ${type} (${modifiers[type] === 1.2 ? '+20%' : '-20%'}: ${result})`);
                return result;
            },
            effective: (atk, isEffective, log) => {
                if (isEffective === 'yes') {
                    atk = Math.floor(atk * 1.5);
                    log.push(`Effective Damage (x1.5): ${atk}`);
                }
                return atk;
            },
            terrain: (def, type, log) => {
                if (type === 'defensive') {
                    def = Math.floor(def * 1.3);
                    log.push(`Defensive Terrain (+30%): ${def}`);
                }
                return def;
            },
            special: (baseDamage, def, type, damageType, log) => {
                const specials = {
                    moonbow: () => Math.floor(def * 0.3),
                    glimmer: () => Math.floor(baseDamage * 0.5),
                    astra: () => Math.floor(baseDamage * 1.5)
                };
                const damage = specials[type]?.() || 0;
                if (damage) log.push(`${type.charAt(0).toUpperCase() + type.slice(1)}: +${damage}`);
                return damage;
            }
        };

        // Main Calculation Logic
        function calculateDamage() {
            const log = [];

            // Fetch all inputs once
            const inputs = {
                attacker: {
                    atk: getInput('atk', 0, 99) + getInput('atkBuff', -99, 99),
                    spd: getInput('atkSpd', 0, 99),
                    hp: getInput('atkHP', 0, 99),
                    maxHP: getInput('atkMaxHP', 0, 99, getInput('atkHP', 0, 99))
                },
                defender: {
                    def: getInput('def', 0, 99) + getInput('defBuff', -99, 99),
                    res: getInput('res', 0, 99) + getInput('defBuff', -99, 99),
                    spd: getInput('defSpd', 0, 99),
                    hp: getInput('defHP', 0, 99),
                    maxHP: getInput('defMaxHP', 0, 99, getInput('defHP', 0, 99))
                },
                combat: {
                    damageType: getSelect('damageType'),
                    weaponType: getSelect('weaponType'),
                    triangle: getSelect('triangle'),
                    effective: getSelect('effective'),
                    special: getSelect('special'),
                    trueDamage: getInput('trueDamage', 0, 99),
                    preCombatDamage: getInput('preCombatDamage', 0, 99),
                    unmitigated: getCheckbox('unmitigated'),
                    emblemEffect: getSelect('emblemEffect'),
                    cantoDistance: getInput('cantoDistance', 0, 4),
                    cantoActive: getCheckbox('cantoActive'),
                    pierceDR: getInput('pierceDR', 0, 100),
                    critical: parseFloat(getSelect('critical')),
                    terrain: getSelect('terrain'),
                    percentReduction: getInput('percentReduction', 0, 100),
                    fixedReduction: getInput('fixedReduction', 0, 99)
                },
                advanced: {
                    statCompare: getSelect('statCompare'),
                    hpThreshold: getSelect('hpThreshold'),
                    statConvertPercent: getInput('statConvertPercent', 0, 100),
                    statConvert: getSelect('statConvert'),
                    statScale: getInput('statScale', 0, 10)
                },
                skills: {
                    heavyBlade: getCheckbox('heavyBlade'),
                    deflectMagic: getCheckbox('deflectMagic') && getSelect('damageType') === 'magical',
                    savior: getCheckbox('savior'),
                    warpBubble: getCheckbox('warpBubble'),
                    nullFollowUp: getCheckbox('nullFollowUp'),
                    guaranteeFollowUp: getCheckbox('guaranteeFollowUp')
                },
                options: {
                    extraActions: getInput('extraActions', 0, 3),
                    galeforce: getCheckbox('galeforce'),
                    divineVein: getSelect('divineVein'),
                    counter: getCheckbox('counter'),
                    forecast: getCheckbox('forecast')
                }
            };

            // Validation
            if (!inputs.attacker.atk || (!inputs.defender.def && !inputs.defender.res)) {
                log.push("Please enter Atk and at least one of Def or Res values.");
                updateUI(log);
                return;
            }

            // Stat Logging
            log.push(`Attacker: Atk ${inputs.attacker.atk}, Spd ${inputs.attacker.spd}, HP ${inputs.attacker.hp}/${inputs.attacker.maxHP}`);
            log.push(`Defender: Def ${inputs.defender.def}, Res ${inputs.defender.res}, Spd ${inputs.defender.spd}, HP ${inputs.defender.hp}/${inputs.defender.maxHP}`);

            // Adaptive Damage
            const effectiveDef = inputs.combat.damageType === 'physical' ? inputs.defender.def :
                                 inputs.combat.damageType === 'magical' ? inputs.defender.res : Math.min(inputs.defender.def, inputs.defender.res);
            log.push(`Effective ${inputs.combat.damageType === 'physical' ? 'Def' : 'Res'}: ${effectiveDef}`);

            // Pre-Combat Damage
            let totalDamage = inputs.combat.unmitigated ? inputs.combat.preCombatDamage : Math.max(0, inputs.combat.preCombatDamage - effectiveDef);
            if (inputs.combat.preCombatDamage) log.push(`Pre-Combat Damage: ${totalDamage}${inputs.combat.unmitigated ? ' (Unmitigated)' : ''}`);

            // Emblem Effects
            let drPierce = inputs.combat.pierceDR / 100;
            let counterAllowed = inputs.options.counter;
            if (inputs.combat.emblemEffect === 'ike') {
                counterAllowed = true;
                log.push("Emblem Ike: Nullifies counter disruption, 40% DR on first hit");
            } else if (inputs.combat.emblemEffect === 'lyn') {
                totalDamage += 7;
                log.push("Emblem Lyn: +7 True Damage");
            }

            // Canto
            if (inputs.combat.cantoActive) log.push(`Canto (${inputs.combat.cantoDistance}): Unit can reposition`);

            // Core Modifiers
            let atkModified = modifyStats.triangle(inputs.attacker.atk, inputs.combat.triangle, log);
            atkModified = modifyStats.effective(atkModified, inputs.combat.effective, log);
            let defModified = modifyStats.terrain(effectiveDef, inputs.combat.terrain, log);

            // Stat Interactions
            const statBoosts = {
                atkVsDef: Math.floor(Math.max(0, atkModified - defModified) / 5),
                spdVsSpd: Math.floor(Math.max(0, inputs.attacker.spd - inputs.defender.spd) / 5)
            };
            if (inputs.advanced.statCompare !== 'none') {
                const boost = statBoosts[inputs.advanced.statCompare] || 0;
                totalDamage += boost;
                log.push(`Stat Comparison (${inputs.advanced.statCompare}): +${boost}`);
            }

            let baseDamage = Math.max(0, atkModified - defModified);
            totalDamage += baseDamage;
            log.push(`Base Damage: ${baseDamage}`);

            const specialDamage = inputs.skills.heavyBlade ? modifyStats.special(baseDamage, defModified, inputs.combat.special, inputs.combat.damageType, log) : 0;
            if (inputs.skills.heavyBlade && inputs.combat.special !== 'none') log.push("Heavy Blade: Special triggered");
            totalDamage += specialDamage;

            if (inputs.combat.trueDamage) {
                totalDamage += inputs.combat.trueDamage;
                log.push(`True Damage: +${inputs.combat.trueDamage}`);
            }

            const hpPercent = inputs.attacker.hp / inputs.attacker.maxHP;
            if (inputs.advanced.hpThreshold === 'high' && hpPercent >= 0.8) {
                totalDamage += 5;
                log.push("High HP Threshold (≥80%): +5 Damage");
            }

            if (inputs.advanced.statConvertPercent && inputs.advanced.statConvert !== 'none') {
                const convertValue = inputs.advanced.statConvert === 'spd' ? inputs.attacker.spd : defModified;
                const convertDamage = Math.floor(convertValue * (inputs.advanced.statConvertPercent / 100));
                totalDamage += convertDamage;
                log.push(`Stat Conversion (${inputs.advanced.statConvertPercent}% of ${inputs.advanced.statConvert}): +${convertDamage}`);
            }

            if (inputs.advanced.statScale) {
                const totalStats = Object.values(inputs.attacker).reduce((a, b) => a + b, 0) + Object.values(inputs.defender).reduce((a, b) => a + b, 0);
                const scaleDamage = Math.floor(totalStats / 10) * inputs.advanced.statScale;
                totalDamage += scaleDamage;
                log.push(`Dynamic Stat Scaling (${totalStats} total stats, ${inputs.advanced.statScale}/10): +${scaleDamage}`);
            }

            if (inputs.combat.critical > 1) {
                totalDamage = Math.floor(totalDamage * inputs.combat.critical);
                log.push(`Critical (x${inputs.combat.critical}): ${totalDamage}`);
            }

            const staffMod = inputs.combat.weaponType === 'staff' ? 0.5 : 1;
            totalDamage = Math.floor(totalDamage * staffMod);
            if (inputs.combat.weaponType === 'staff') log.push(`Staff Modifier (x0.5): ${totalDamage}`);

            // Damage Reduction
            let totalReduction = inputs.combat.percentReduction / 100;
            if (inputs.skills.deflectMagic) totalReduction += 0.5;
            if (inputs.combat.emblemEffect === 'ike') totalReduction += 0.4;
            if (inputs.options.divineVein === 'stone') totalReduction += 0.2;
            if (inputs.advanced.hpThreshold === 'low' && hpPercent < 0.5) totalReduction += 0.2;
            if (inputs.skills.savior) totalDamage -= 10;
            if (totalReduction > 0) {
                const piercedReduction = totalReduction * (1 - drPierce);
                totalDamage = Math.floor(totalDamage * (1 - piercedReduction));
                log.push(`Total Reduction (${Math.round(totalReduction * 100)}% pierced to ${Math.round(piercedReduction * 100)}%): ${totalDamage}`);
                if (inputs.skills.savior) log.push("Savior: Additional -10 damage");
            }

            if (inputs.skills.warpBubble) log.push("Warp Bubble: Enemy movement restricted");

            // Follow-Up Logic
            let followUpDamage = 0;
            if (inputs.skills.guaranteeFollowUp || (!inputs.skills.nullFollowUp && inputs.attacker.spd >= inputs.defender.spd + 5)) {
                followUpDamage = totalDamage;
                totalDamage += followUpDamage;
                log.push(inputs.skills.guaranteeFollowUp ? "Guaranteed Follow-Up" : `Follow-Up Attack (Spd ${inputs.attacker.spd} vs ${inputs.defender.spd})` + `: +${followUpDamage}`);
            } else if (inputs.skills.nullFollowUp) {
                log.push("Null Follow-Up: Prevents defender follow-up");
            }

            if (inputs.options.galeforce && inputs.options.extraActions > 0) {
                totalDamage *= (1 + inputs.options.extraActions);
                log.push(`Galeforce: ${inputs.options.extraActions} extra actions, total damage x${1 + inputs.options.extraActions}`);
            }

            if (inputs.options.divineVein === 'flame') {
                totalDamage += 10;
                log.push("Divine Vein (Flame): +10 True Damage");
            }

            // Counterattack
            let atkRemainingHP = inputs.attacker.hp;
            let defRemainingHP = inputs.defender.hp - totalDamage;
            if (counterAllowed && defRemainingHP > 0) {
                const counterDef = inputs.combat.damageType === 'physical' ? inputs.defender.def : inputs.defender.res;
                let counterDamage = Math.max(0, counterDef - inputs.attacker.atk);
                if (inputs.combat.emblemEffect === 'ike') counterDamage = Math.floor(counterDamage * 0.6);
                atkRemainingHP = Math.max(0, inputs.attacker.hp - counterDamage);
                log.push(`Counterattack: ${counterDamage} to Attacker`);
            }
            log.push(`HP Remaining - Attacker: ${atkRemainingHP}, Defender: ${defRemainingHP}`);

            if (inputs.options.forecast) {
                const forecastDamage = Math.floor((baseDamage + specialDamage + inputs.combat.trueDamage) * staffMod);
                log.push(`Combat Forecast: ${forecastDamage}`);
            }

            updateUI(log, totalDamage);
        }

        function updateUI(log, damage = '-') {
            document.getElementById('result').innerText = `Damage: ${damage}`;
            document.getElementById('log').innerHTML = log.map(step => `<p>${step}</p>`).join('');
        }

        function resetForm() {
            document.querySelectorAll('input[type="number"]').forEach(input => input.value = '');
            document.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
            updateUI(["Calculation steps will appear here."]);
        }
    </script>
</body>
</html>
